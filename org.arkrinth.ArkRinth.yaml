# This is a Flatpak manifest file for building the ArkRinth application.
# Save this file as `org.arkrinth.ArkRinth.yaml` in the root of your repository.

app-id: org.arkrinth.ArkRinth
runtime: org.gnome.Platform
runtime-version: '45'
sdk: org.gnome.Sdk
command: ArkRinth
finish-args:
  # Basic access to the X11 and Wayland display servers
  - --socket=x11
  - --socket=wayland

  # Access to the sound server
  - --socket=pulseaudio

  # D-Bus access for some desktop functionality
  - --share=ipc

  # Allow the app to see the host's desktop theme, fonts, etc.
  - --filesystem=xdg-config/gtk-3.0
  - --filesystem=xdg-config/gtk-4.0
  - --filesystem=xdg-config/fontconfig
  - --filesystem=~/.themes
  - --filesystem=~/.local/share/themes

  # Network access is required for most web-based applications
  - --share=network

modules:
  - name: ArkRinth
    builddir: true
    buildsystem: simple
    sources:
      # This pulls the source code directly from your Git repository.
      - type: git
        url: .
        commit: HEAD
    
    # Dependencies required to build your Tauri app
    build-options:
      env:
        # Set RUSTFLAGS to optimize the build.
        RUSTFLAGS: "-C strip=debuginfo"

    # Install Rust, Node.js, and other system dependencies.
    # Note: These are a simplified set of dependencies; you might need to add more.
    build-depends:
      - rust
      - nodejs
      - pnpm
      - libwebkit2gtk-4.1-dev
      - libayatana-appindicator3-dev
      - librsvg2-dev
      - libegl1-mesa-dev
      - libgl1-mesa-dev

    # The actual build commands to compile the Tauri app
    build-commands:
      # You may need to grant execute permissions here as well
      - chmod +x ./packages/app-lib/java/gradlew

      # Install dependencies using pnpm
      - pnpm install

      # Use Dasel to set the version number from the commit hash
      - dasel put -f apps/app/Cargo.toml -t string -v "${FLATPAK_BUILDER_APP_VERSION}" 'package.version'
      - dasel put -f packages/app-lib/Cargo.toml -t string -v "${FLATPAK_BUILDER_APP_VERSION}" 'package.version'
      - dasel put -f apps/app-frontend/package.json -t string -v "${FLATPAK_BUILDER_APP_VERSION}" 'version'

      # Build the application with Tauri's bundler for Flatpak
      - pnpm --filter=@modrinth/app run tauri build --config tauri-release.conf.json --bundles "flatpak"
      
    # This command is for installing the final application and its desktop file
    # This may need to be adjusted based on the output of your Tauri build
    install-commands:
      - install -Dm755 target/release/ArkRinth ${FLATPAK_DEST}/bin/ArkRinth
      - install -Dm644 apps/app/resources/org.arkrinth.ArkRinth.desktop ${FLATPAK_DEST}/share/applications/org.arkrinth.ArkRinth.desktop
      - install -Dm644 apps/app/resources/icons/icon.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/org.arkrinth.ArkRinth.png

