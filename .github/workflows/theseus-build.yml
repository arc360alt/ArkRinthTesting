name: ArkRinth build
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - .github/workflows/theseus-build.yml
      - 'apps/app/**'
      - 'apps/app-frontend/**'
      - 'packages/app-lib/**'
      - 'packages/app-macros/**'
      - 'packages/assets/**'
      - 'packages/ui/**'
      - 'packages/utils/**'
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest, ubuntu-22.04]
        include:
          - platform: macos-latest
            artifact-target-name: universal-apple-darwin
          - platform: windows-latest
            artifact-target-name: x86_64-pc-windows-msvc
          - platform: ubuntu-22.04
            artifact-target-name: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.platform }}

    steps:
      - name: ðŸ“¥ Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§° Setup Java for Gradle
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ§° Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rustflags: ''
          target: ${{ startsWith(matrix.platform, 'macos') && 'x86_64-apple-darwin' || '' }}
          cache-key: ${{ matrix.platform }}-${{ hashFiles('**/Cargo.lock') }}

      - name: ðŸ§° Install pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: ðŸ§° Install Linux build dependencies
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -yq \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libegl1-mesa-dev \
            libgl1-mesa-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxkbcommon-dev \
            libgtk-3-dev \
            rpm
        

      - name: âš™ï¸ Grant execute permissions to gradlew
        if: startsWith(matrix.platform, 'ubuntu') || startsWith(matrix.platform, 'macos')
        run: chmod +x ./packages/app-lib/java/gradlew

      - name: ðŸ§° Setup Dasel
        uses: jaxxstorm/action-install-gh-release@v2.1.0
        with:
          repo: TomWright/dasel
          tag: v2.8.1
          extension-matching: disable
          rename-to: ${{ startsWith(matrix.platform, 'windows') && 'dasel.exe' || 'dasel' }}
          chmod: 0755

      - name: ðŸ·ï¸ Get version info
        id: get-version-info
        shell: bash
        run: |
          git fetch --tags --force
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          COMMIT_COUNT=$(git rev-list --count ${LATEST_TAG}..HEAD 2>/dev/null || echo "0")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "latest-tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "commit-count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "short-sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Set application version
        shell: bash
        run: |
          git fetch --tags --force
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          COMMIT_COUNT=$(git rev-list --count ${LATEST_TAG}..HEAD 2>/dev/null || echo "0")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          # Ensure the latest tag has proper semver format (x.y.z)
          CLEAN_TAG="${LATEST_TAG#v}"
          if [[ ! "$CLEAN_TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # If tag doesn't have patch version, add .0
            if [[ "$CLEAN_TAG" =~ ^[0-9]+\.[0-9]+$ ]]; then
              CLEAN_TAG="${CLEAN_TAG}.0"
            else
              CLEAN_TAG="1.0.0"
            fi
          fi
          
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            APP_VERSION="$CLEAN_TAG"
          else
            # Use proper semver prerelease format
            APP_VERSION="${CLEAN_TAG}-canary.${COMMIT_COUNT}.${SHORT_SHA}"
          fi
          
          echo "Setting application version to $APP_VERSION"
          dasel put -f apps/app/Cargo.toml -t string -v "$APP_VERSION" 'package.version'
          dasel put -f packages/app-lib/Cargo.toml -t string -v "$APP_VERSION" 'package.version'
          dasel put -f apps/app-frontend/package.json -t string -v "$APP_VERSION" 'version'

      - name: ðŸ’¨ Setup Turbo cache
        uses: rharkor/caching-for-turbo@v1.8

      - name: ðŸ§° Install dependencies
        run: pnpm install

      - name: ðŸ”¨ Build macOS app
        run: pnpm --filter=@modrinth/app run tauri build --target universal-apple-darwin --config tauri-release.conf.json
        if: startsWith(matrix.platform, 'macos')
        # Removed TAURI_SIGNING_PRIVATE_KEY and TAURI_SIGNING_PRIVATE_KEY_PASSWORD env variables
        # env:
        #   TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        #   TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: ðŸ”¨ Build Linux app
        run: pnpm --filter=@modrinth/app run tauri build --config tauri-release.conf.json
        if: startsWith(matrix.platform, 'ubuntu')
        # Removed TAURI_SIGNING_PRIVATE_KEY and TAURI_SIGNING_PRIVATE_KEY_PASSWORD env variables
        # env:
        #   TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        #   TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: ðŸ”¨ Build Windows app
        run: |
          $env:JAVA_HOME = "$env:JAVA_HOME_11_X64"
          pnpm --filter=@modrinth/app run tauri build --config tauri-release.conf.json --verbose --bundles 'nsis,updater'
        if: startsWith(matrix.platform, 'windows')
        # Removed TAURI_SIGNING_PRIVATE_KEY and TAURI_SIGNING_PRIVATE_KEY_PASSWORD env variables
        # env:
        #   TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        #   TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: ðŸ“¤ Upload app bundles
        uses: actions/upload-artifact@v4
        with:
          name: App bundle (${{ matrix.artifact-target-name }})
          path: |
            target/release/bundle/appimage/ArkRinth_*.AppImage*
            target/release/bundle/deb/ArkRinth_*.deb*
            target/release/bundle/rpm/ArkRinth-*.rpm*
            target/universal-apple-darwin/release/bundle/macos/ArkRinth_.app.tar.gz*
            target/universal-apple-darwin/release/bundle/dmg/ArkRinth_*.dmg*
            target/release/bundle/nsis/ArkRinth_*-setup.exe*
            target/release/bundle/nsis/ArkRinth_*-setup.nsis.zip*
